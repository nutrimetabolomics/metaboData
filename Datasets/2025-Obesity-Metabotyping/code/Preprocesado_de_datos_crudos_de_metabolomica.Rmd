
---
title: "Preprocesado de datos crudos de metabolomica"
author: "Alex Sanchez"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

*Aixo es una proposta de ChatGPT per descarregar i analitzar les dades de l'estudi "ST002993" de Metabolomics workbench.*
*No funciona, pero ni que ho faci no se si es fiable ja que les dades venen de quatre plataformes diferents.*


## 1. Descargar datos del Metabolomics Workbench

```{r download-data}
library(httr)

study_id <- "ST002993"
dest_zip <- paste0(study_id, ".zip")

if (!file.exists(dest_zip)) {
  url <- paste0("https://www.metabolomicsworkbench.org/rest/study/study_id/", study_id, "/download/zip")
  download.file(url, destfile = dest_zip)
}

if (!dir.exists(study_id)) {
  unzip(dest_zip, exdir = study_id)
}
```

## 2. Localizar archivos `.mzXML`

```{r list-files}
mzxml_files <- list.files(path = study_id, pattern = "\\.mzXML$", recursive = TRUE, full.names = TRUE)
stopifnot(length(mzxml_files) > 0)
```

## 3. Procesamiento con `xcms`

```{r xcms-processing}
library(xcms)
library(MSnbase)

raw_data <- readMSData(files = mzxml_files, mode = "onDisk")

# Configurar parámetros
cwp <- CentWaveParam(ppm = 30, peakwidth = c(5, 20), snthr = 10)
xdata <- findChromPeaks(raw_data, param = cwp)

# Alineamiento y agrupación
xdata <- adjustRtime(xdata, param = ObiwarpParam())
xdata <- groupChromPeaks(xdata, param = PeakDensityParam(sampleGroups = rep(1, length(mzxml_files))))
xdata <- fillChromPeaks(xdata)
```

## 4. Exportar tabla de intensidades

```{r export-feature-table}
feature_table <- featureValues(xdata, method = "medret", value = "into")
write.csv(feature_table, "feature_table_ST002993_raw.csv")
```

## 5. Filtrado y normalización

```{r normalization}
# Filtrar metabolitos con muchos NA
na_prop <- rowMeans(is.na(feature_table))
feature_table_filt <- feature_table[na_prop <= 0.2, ]

# Imputación simple con mínimos no nulos
feature_table_imp <- apply(feature_table_filt, 2, function(x) {
  x[is.na(x)] <- min(x[x > 0], na.rm = TRUE)
  x
})

# Normalización por sumas (TIC)
feature_table_norm <- sweep(feature_table_imp, 2, colSums(feature_table_imp), FUN = "/")

write.csv(feature_table_norm, "feature_table_ST002993_filtered_normalized.csv")
```

## 6. Visualización exploratoria

```{r exploratory}
library(pheatmap)

pheatmap(cor(feature_table_norm), main = "Correlación entre muestras")

pca <- prcomp(t(feature_table_norm), scale. = TRUE)
plot(pca$x[,1:2], col = "blue", pch = 16, main = "PCA de muestras")
```
